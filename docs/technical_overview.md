# Technical Overview: Fathom Rider Plugin

This document provides deep technical details on the implementation, architecture, and design decisions of the Fathom Rider plugin.

## Implementation Background

ReSharper's **Solution-Wide Error Analysis (SWEA)** continuously analyzes all files in a solution in the background. The results are cached in memory. This plugin taps into those cached results (or falls back to per-file daemon analysis) using the same internal APIs that ReSharper's built-in "Inspect Code" feature uses.

### Key APIs Used

- **`SolutionAnalysisManager`** (`JetBrains.ReSharper.Daemon.SolutionAnalysis`): facade for SWEA, provides `IssueSet` with cached analysis results
- **`SolutionAnalysisConfiguration`** (`JetBrains.ReSharper.Daemon`): exposes `Paused` and `CompletedOnceAfterStart` properties to check SWEA status
- **`CollectInspectionResults.CollectIssuesFromSolutionAnalysis()`** (`JetBrains.ReSharper.Daemon.SolutionAnalysis.RunInspection`): public static method that reads cached SWEA results per file
- **`IssuePointer`**: result type with `Message`, `GetSeverity()`, `Range`, `NavigationOffset`, `IsValid`

### Approaches We Deliberately Avoid

- **`IDocumentMarkupManager` / highlighter enumeration**: only works for files that have an active document model (opened in editor tabs). This misses the vast majority of files in a solution.
- **External `inspectcode.exe`**: JetBrains ships a standalone command-line inspection tool, but we want in-process access to the live analysis state with zero extra configuration or process spawning.
- **Custom daemon stages**: writing our own `IDaemonStage` would let us hook into the analysis pipeline, but it's unnecessary complexity when SWEA already caches exactly the results we need.

## HTTP API Implementation Details

### `/blueprints` Implementation
Uses **reflection** to access `UE4AssetsCache` and `UE4SearchUtil` from `JetBrains.ReSharper.Feature.Services.Cpp.dll` without needing a closed-source DLL reference. Performs recursive BFS to find Blueprint-to-Blueprint derivation chains.

**Known limitation:** Only discovers Blueprints that directly derive from the queried class or from other Blueprints in its hierarchy. Blueprints that derive from **C++ intermediate subclasses** are not found, because the asset cache has no C++ class hierarchy API.

### `/blueprint-audit` Implementation
Reads Blueprint audit Markdown files generated by the **FathomUELink** companion plugin.
- **Staleness detection**: Compares the `Hash` header field in each `.md` file against the current `.uasset` file's MD5 hash.
- **Background refresh**: Spawns `UnrealEditor-Cmd.exe -run=BlueprintAudit` to regenerate audit data.
- **Boot check**: Automatically checks for staleness 5 seconds after solution load and triggers refresh if needed.
- **Mutex protection**: Only one refresh can run at a time.

## Architecture

```
Fathom/
├── src/dotnet/ReSharperPlugin.Fathom/
│   ├── FathomRiderHttpServer.cs           # HTTP server entry point ([SolutionComponent])
│   ├── Handlers/                         # Endpoint-specific request handlers
│   ├── Services/                         # Core logic (Inspection, Blueprint Query, Audit)
│   ├── Formatting/                       # Markdown/JSON output formatting
│   ├── Models/                           # DTOs and Data models
│   └── Serialization/                     # JSON helpers
├── src/rider/main/
│   ├── kotlin/                           # IntelliJ/Rider frontend (Settings UI, RD Host)
│   └── resources/META-INF/               # Plugin descriptor (plugin.xml)
├── protocol/                             # RD protocol definitions
├── scripts/                              # Build and setup scripts
└── docs/                                 # Detailed documentation
```

## Cross-Repo Coordination

This plugin works with the companion [Fathom-UnrealEngine](https://github.com/Tideshift-Labs/Fathom-UnrealEngine) UE editor plugin.
- **Audit schema version**: `BlueprintAuditService.AuditSchemaVersion` must match `FAuditFileUtils::AuditSchemaVersion` in the UE repo (canonical constant; `FBlueprintAuditor::AuditSchemaVersion` proxies it).
- **Audit output path**: `Saved/Fathom/Audit/v<N>/Blueprints/...`. The `v<N>` version segment invalidates cached files automatically.
- **Commandlet name**: The plugin invokes `UnrealEditor-Cmd.exe -run=BlueprintAudit`.

## Environment Notes

- **Windows-only**: Currently uses hardcoded paths like `Win64` and `UnrealEditor-Cmd.exe`.
- **Port**: Defaults to 19876. Configurable via Settings > Tools > Fathom or `RIDER_INSPECTOR_PORT`. If the configured port is already in use, the server tries up to 10 consecutive ports before failing.
- **Desktop marker file**: `resharper-http-server.txt` is written on startup to confirm the server component loaded.
- **Symlinks**: Use Junctions (`New-Item -ItemType Junction`) to avoid permission issues.
